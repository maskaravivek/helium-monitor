<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Helium Monitor</title>
    <link rel="stylesheet" href="css/bulma.min.css">
    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDrAiZvSDHjw6fkLR-KQ40LztUmoXgXw5w&libraries=places&callback=initAutocomplete"></script>
    <script>
        function initAutocomplete() {
            var geocoder = new google.maps.Geocoder();
            var latitude = -33.8688
            var longitude = 151.2195;

            const map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: latitude, lng: longitude },
                zoom: 13,
                mapTypeId: "roadmap",
            });
            // Create the search box and link it to the UI element.
            const input = document.getElementById("pac-input");
            const searchBox = new google.maps.places.SearchBox(input);
            map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);
            // Bias the SearchBox results towards current map's viewport.
            map.addListener("bounds_changed", () => {
                searchBox.setBounds(map.getBounds());
            });
            let markers = [];
            // Listen for the event fired when the user selects a prediction and retrieve
            // more details for that place.
            searchBox.addListener("places_changed", () => {
                const places = searchBox.getPlaces();

                if (places.length == 0) {
                return;
                }
                // Clear out the old markers.
                markers.forEach((marker) => {
                marker.setMap(null);
                });
                markers = [];
                // For each place, get the icon, name and location.
                const bounds = new google.maps.LatLngBounds();
                number_places = places.length
                places.forEach((place) => {
                if (!place.geometry || !place.geometry.location) {
                    console.log("Returned place contains no geometry");
                    return;
                }
                if (number_places == 1) {
                    latitude = place.geometry.location.lat();
                    longitude = place.geometry.location.lng();
                    document.getElementById('latitude').value = latitude;
                    document.getElementById('longitude').value = longitude;

                    var url = "https://api.helium.io/v1/hotspots/location/distance?lat=" + latitude + "&lon=" + longitude + "&distance=1000";

                    fetch(url)
                        .then((response) => {
                            return response.json();
                        })
                        .then((myJson) => {
                            element = document.getElementById('nearby_hotspots')
                            element.value = JSON.stringify(myJson);
                            
                            var event = new Event('change');
                            element.dispatchEvent(event);
                        });
                }

                // Create a marker for each place.
                markers.push(
                    new google.maps.Marker({
                    map,
                    position: place.geometry.location,
                    animation: google.maps.Animation.DROP,
                    })
                );

                if (place.geometry.viewport) {
                    // Only geocodes have viewport.
                    bounds.union(place.geometry.viewport);
                } else {
                    bounds.extend(place.geometry.location);
                }
                });

                map.fitBounds(bounds);
            });

            google.maps.event.addListener(map, 'click', (event) => {
                var location = event.latLng;

                if (!location){
                    console.log("Returned place contains no geometry");
                    return;
                }

                markers.forEach((marker) => {
                marker.setMap(null);
                });
                markers = [];

                // For each place, get the icon, name and location.
                const bounds = new google.maps.LatLngBounds();

                latitude = location.lat();
                longitude = location.lng();
                document.getElementById('latitude').value = latitude;
                document.getElementById('longitude').value = longitude;

                // Create a marker for each place.
                markers.push(
                    new google.maps.Marker({
                    map,
                    position: location,
                    animation: google.maps.Animation.DROP,
                    })
                );

                geocoder.geocode({
                    'latLng': location
                }, function (results, status) {
                    if (status ==
                        google.maps.GeocoderStatus.OK) {
                        if (results[1]) {
                            document.getElementById('pac-input').value = results[1].formatted_address;
                        } else {
                            console.log('No results found');
                        }
                    } else {
                        console.log('Geocoder failed due to: ' + status);
                    }
                });

                var url = "https://api.helium.io/v1/hotspots/location/distance?lat=" + latitude + "&lon=" + longitude + "&distance=1000";

                fetch(url)
                    .then((response) => {
                        return response.json();
                    })
                    .then((myJson) => {
                        element = document.getElementById('nearby_hotspots')
                        element.value = JSON.stringify(myJson);
                        
                        var event = new Event('change');
                        element.dispatchEvent(event);
                    });

            });

            }
    </script>
</head>

<body>
    <section class="section">
        <div class="container">
            <div id='configs-div'>
                <div class='columns is-vcentered is-mobile'>
                    <div class="is-size-4 mr-6">
                        <button style="border: none;" id='home_btn' class="button">
                            <img style="cursor:pointer;" title="Home" height="24" width="24" src="assets/home.png">
                        </button>
                        <span>Configure</span>
                    </div>
                    <div style="text-align: right;" class='column ml-1'>
                        <button style="border: none;" id='hotspot_btn' class="button">
                            <img id='hotspot_btn_icon' style="cursor:pointer;" title="Check eligibility for new hotspot" height="24"
                                width="24" src="assets/hotspot.png">
                        </button>
                        <button style="border: none;" id='add_btn' class="button">
                            <img id='add_btn_icon' style="cursor:pointer;" title="Add new hotspot" height="24"
                                width="24" src="assets/add.png">
                        </button>
                    </div>
                </div>
                <div>
                    <div id='hotspot_div'>
                        <span class="is-size-7">Manage Hotspots</span><br /><br />
                        <div id='hotspot_list' class='tags'>

                        </div>

                        <span class="is-size-7">Choose currency: </span><br /><br />
                        <div class="select">
                            <select id="currency_select">
                            </select>
                        </div><br /><br />
                    </div>
                    <div style="display: none;" id="add_new_hotspot_div">
                        <div>
                            <input placeholder="Enter Hotspot Name. Eg. spare-fleece-urchin"
                                class="input is-primary mt-3" type="text" id="hotspot_name" name="hotspot_name"><br />
                            <span style="font-size: 10px; color: red;" id="add_hotspot_error"></span><br />
                        </div>
                        <div>
                            <span style="vertical-align: middle;">Your % share:</span> <input class="input is-primary"
                                style="width: 40%;" id="percentage" type="number" min="0" max="100" value="100">
                            <span style="float: right;">
                                <button class="button is-primary" id='save_btn' type="save" value="save">Save</button>
                                <button class="button ml-1" id='cancel_btn' type="cancel" value="cancel">Cancel</button>
                            </span>
                        </div>
                    </div>
                    <div style="display: none;" id="check_hotspot_eligibility_div">
                        <h3><b>Check to see hotspot eligibility!</b></h3>

                        <span class='mr-6' style="font-size: 1.05em;" id='nearby_hotspot_status'></span><br />
                        <a id='emrit_hotspot_link' class="is-hidden">Get a free Hotspot</a>

                        <div class="row">
                            <div class="form-group col-xs-12">
                                <input
                                    id="pac-input"
                                    class="controls"
                                    type="text"
                                    placeholder="Search Box"
                                />
                                <input type="hidden" id="nearby_hotspots" name="nearby_hotspots" class="form-control"
                                    placeholder="Nearby Hotspots" value="N/A" />
                                <input type="hidden" id="latitude" name="latitude" class="form-control"
                                    placeholder="Latitude" value="0.00" />
                                <input type="hidden" id="longitude" name="longitude" class="form-control"
                                    placeholder="Longitude" value="0.00" />
                            </div>
                        </div>
                        <div id="map" style="height:20em; width:35em"></div>
                    </div>

                    <div style="text-align: center">
                        <button id='coffee_btn'
                            class="button is-half is-centered is-primary mt-6 has-text-centered is-hidden">
                            <img width="128" src="assets/buy-me-a-coffee.png">
                        </button> <br /><br />
                        <a id='new_hotspot_link' class="is-hidden">Buy a new Hotspot</a>
                    </div>


                </div>
            </div>
            <div id='earnings-div'>
                <div class='columns is-vcentered is-mobile'>
                    <div class="column is-size-4">
                        <span>Earnings</span>
                        <img id='status_icon' style="cursor:pointer;" title="Device status" height="16" width="16"
                            src="assets/unknown.png">
                    </div>
                    <div class="column">
                        <div class="select is-small is-info is-rounded">
                            <select style="width: 160px;" id='device_select'>
                                <option>All devices</option>
                            </select>
                        </div>
                    </div>
                    <div style="text-align: right;" class='column'>
                        <button style="width: 56px; border: none;" id='refresh_btn' class="button is-loading">
                            <img id='refresh_btn_icon' height="24" width="24" src="assets/refresh.png">
                        </button>
                        <button style="border: none;" id='web_btn' class="button">
                            <img height="24" width="24" src="assets/globe.png">
                        </button>
                        <button style="border: none;" class="button" id='edit_configs'>
                            <img height="24" width="24" src="assets/settings.png">
                        </button>
                    </div>
                </div>

                <div class="box has-text-centered">
                    <span class='mr-6' style="font-size: 1.3em;" id='last-day-window-usd'></span>
                    <span class='ml-6' style="font-size: 1.3em;" id='last-day-window-hnt'></span><br />
                    <span style="font-size: 0.6em; color: green;" id='last-1-hour-hnt'></span><br />
                    <span style="font-size: 0.5em;">Last 24 hours</span>
                </div>
                <div class="columns is-mobile">
                    <div class="column">
                        <div class="box has-text-centered">
                            <span style="font-size: 1.3em;" id='last-7-day-window-usd'></span><br />
                            <span style="font-size: 0.7em;" id='last-7-day-window-hnt'></span><br />
                            <span style="font-size: 0.5em;">Last 7 days</span>
                        </div>
                    </div>
                    <div class="column">
                        <div class="box has-text-centered">
                            <span style="font-size: 1.3em;" id='summary-window-usd'></span><br />
                            <span style="font-size: 0.7em;" id='summary-window-hnt'></span><br />
                            <span style="font-size: 0.5em;">Last 30 days</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <script src="scripts/require.js"></script>
    <script type="module" src="scripts/index.js"></script>
</body>


</html>